<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>C42 Flight Buddy - CheckWX METAR</title>
<style>
  body { font-family: Arial, sans-serif; max-width: 600px; margin: auto; padding: 20px; background: #f5f5f5; color: #333; }
  input, button { padding: 10px; margin: 5px 0; width: 100%; font-size: 1rem; }
  #results { margin-top: 20px; padding: 15px; background: #fff; border-radius: 5px; white-space: pre-wrap; }
  .ok { color: green; }
  .bad { color: red; }
</style>
</head>
<body>
<h1>C42 Flight Buddy - METAR via CheckWX</h1>
<p><em>Version: 2025-07-01-06</em></p>
<p>Check flight weather from Cardiff Airport (EGFH)</p>

<label for="start">Flight start (GMT):</label>
<input type="datetime-local" id="start" />

<label for="duration">Flight duration (hours):</label>
<input type="number" id="duration" min="0.5" step="0.5" value="1" />

<button onclick="checkFlight()">Check Flight</button>

<div id="results"></div>

<script>
const elevationM = 295; // Airport elevation
const CHECKWX_API_KEY = '1716ac7499b0440ca6d984c09a569c8b';
const ICAO = 'EGFH';

function predictRunway(windDir) {
  const runways = { '04': 40, '22': 220, '10': 100, '28': 280 };
  let best = Object.entries(runways).reduce((a, b) => {
    const aDiff = Math.min(Math.abs(a[1] - windDir), 360 - Math.abs(a[1] - windDir));
    const bDiff = Math.min(Math.abs(b[1] - windDir), 360 - Math.abs(b[1] - windDir));
    return aDiff < bDiff ? a : b;
  });
  return best[0];
}

function checkLimits(windKts, visM, cloudBaseFeet, conditions) {
  if (windKts > 20) return { safe: false, msg: "Wind exceeds C42 limits (>20 kt)" };
  if (visM < 5000) return { safe: false, msg: "Visibility too low (<5000 m)" };
  if (cloudBaseFeet !== null && cloudBaseFeet < 500) return { safe: false, msg: "Cloud base too low (<500 ft)" };
  if (conditions.some(c => c.toLowerCase().includes('fog'))) return { safe: false, msg: "Fog reported - unsafe for flight" };
  if (conditions.some(c => c.toLowerCase().includes('rain'))) return { safe: false, msg: "Rain reported - unsafe for flight" };
  return { safe: true, msg: "" };
}

async function fetchMetar() {
  const resp = await fetch(`https://api.checkwx.com/metar/${ICAO}/decoded`, {
    headers: { 'X-API-Key': CHECKWX_API_KEY }
  });
  if (!resp.ok) throw new Error('Failed to fetch METAR');
  const data = await resp.json();
  if (!data || !data.data || !data.data.length) throw new Error('No METAR data returned');
  return data.data[0];
}

async function checkFlight() {
  const startInput = document.getElementById("start").value;
  const duration = parseFloat(document.getElementById("duration").value);
  const resDiv = document.getElementById("results");
  resDiv.innerHTML = "";

  if (!startInput || isNaN(duration) || duration <= 0) {
    resDiv.innerHTML = '<p class="bad">Please enter a valid start time and duration.</p>';
    return;
  }

  const startTime = new Date(startInput + "Z"); // treat input as GMT
  const now = new Date();
  const maxFuture = new Date(now.getTime() + 5*24*3600*1000);
  const endTime = new Date(startTime.getTime() + duration * 3600 * 1000);

  if (startTime <= now) {
    resDiv.innerHTML = '<p class="bad">Please enter a flight start time in the future (within 5 days).</p>';
    return;
  }
  if (startTime > maxFuture || endTime > maxFuture) {
    resDiv.innerHTML = '<p class="bad">Flight time is beyond the 5-day forecast limit.</p>';
    return;
  }

  resDiv.innerHTML = '<p>Loading METAR data from CheckWX...</p>';

  try {
    const metar = await fetchMetar();

    const pressureQNH = metar.barometer?.pressure_mb || null;
    const pressureQFE = pressureQNH ? (pressureQNH - elevationM * 0.12).toFixed(1) : null;

    const windDir = metar.wind?.degrees || 0;
    const windSpeedKts = metar.wind?.speed_kts || 0;

    const visibilityM = metar.visibility?.meters || 10000;

    let cloudBaseFeet = null;
    if (metar.clouds && metar.clouds.length > 0) {
      let bases = metar.clouds
        .map(c => c.base_feet_agl)
        .filter(b => b !== null && b !== undefined);
      if (bases.length) cloudBaseFeet = Math.min(...bases);
    }

    const conditions = metar.conditions ? metar.conditions.map(c => c.description) : [];

    const runway = predictRunway(windDir);
    const check = checkLimits(windSpeedKts, visibilityM, cloudBaseFeet, conditions);

    let output = `Flight time: ${startTime.toUTCString().replace("UTC","GMT")} for ${duration} hour(s)
QNH (hPa): ${pressureQNH ?? 'N/A'}
QFE (hPa): ${pressureQFE ?? 'N/A'}
Wind: ${windDir}° @ ${windSpeedKts} kt
Visibility: ${visibilityM} m
Cloud base: ${cloudBaseFeet !== null ? cloudBaseFeet + ' ft' : 'N/A'}
Conditions: ${conditions.length ? conditions.join(', ') : 'N/A'}
Predicted Runway: ${runway}
Status: ${check.safe ? '✅ Suitable for flight' : '❌ ' + check.msg}
`;

    resDiv.innerHTML = `<pre>${output}</pre>`;
  } catch (err) {
    resDiv.innerHTML = `<p class="bad">Error: ${err.message}</p>`;
  }
}
</script>
</body>
</html>
