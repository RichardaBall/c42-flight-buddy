<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>C42 Flight Buddy</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 600px;
      margin: auto;
      padding: 20px;
      background: #f5f5f5;
      color: #333;
    }
    input, button {
      padding: 10px;
      margin: 5px 0;
      width: 100%;
      font-size: 1rem;
    }
    #results {
      margin-top: 20px;
      padding: 15px;
      background: #fff;
      border-radius: 5px;
      white-space: pre-wrap;
      font-weight: normal;
    }
    .ok { color: green; }
    .bad { color: red; }
    .warn { color: #d48f00; } /* amber/yellow */
    .highlight-red { color: red; }
    .highlight-yellow { color: #d48f00; }
    .highlight-green { color: green; }
    .inline-bold {
      font-weight: normal;
    }
    .version {
      font-style: italic;
      margin-bottom: 10px;
      font-size: 0.9rem;
      color: #555;
    }
  </style>
</head>
<body>
  <h1>C42 Flight Buddy</h1>
  <p class="version">Version: 16</p>
  <p>Check flight weather from Swansea Airport</p>

  <label for="start">Flight start (GMT):</label>
  <input type="datetime-local" id="start" />

  <label for="duration">Flight duration (hours):</label>
  <input type="number" id="duration" min="0.5" step="0.5" value="1" />

  <button onclick="checkFlight()">Check Flight</button>

  <div id="results"></div>

<script>
const LAT = 51.605;
const LON = -4.064;
const API_KEY = '81a0d8bef1288c6437560f89b336dd33';
const elevation = 295; // meters
const RUNWAYS = { '04': 40, '22': 220, '10': 100, '28': 280 };

function estimateDewPoint(temp, humidity) {
  return temp - ((100 - humidity) / 5);
}

function estimateCloudBase(temp, dewPoint) {
  return Math.round((temp - dewPoint) * 400); // in feet AGL
}

function formatDateUK(date) {
  return date.toUTCString().replace('UTC', 'GMT').replace(/(\d{2}:\d{2}):\d{2}/, '$1');
}

function getIcingRisk(temp, dewPoint, humidity) {
  if (temp <= 0 && temp >= -15 && Math.abs(temp - dewPoint) <= 2 && humidity >= 80) {
    return {risk: "Risk", className: "highlight-red"};
  }
  return {risk: "Low", className: ""};
}

function predictWindShear(surfaceWind, upperWind, runwayDir) {
  if (!surfaceWind || !upperWind) return false;

  const dirDiff = Math.min(Math.abs(surfaceWind.deg - upperWind.deg), 360 - Math.abs(surfaceWind.deg - upperWind.deg));
  const speedDiff = Math.abs((upperWind.speed * 1.94384) - (surfaceWind.speed * 1.94384));

  const runwayDiffSurface = Math.min(Math.abs(surfaceWind.deg - runwayDir), 360 - Math.abs(surfaceWind.deg - runwayDir));
  const runwayDiffUpper = Math.min(Math.abs(upperWind.deg - runwayDir), 360 - Math.abs(upperWind.deg - runwayDir));
  const relevant = runwayDiffSurface <= 45 && runwayDiffUpper <= 45;

  return relevant && (dirDiff > 30 || speedDiff > 15);
}

function predictRunway(windDir) {
  return Object.entries(RUNWAYS).reduce((a, b) => {
    const aDiff = Math.min(Math.abs(a[1] - windDir), 360 - Math.abs(a[1] - windDir));
    const bDiff = Math.min(Math.abs(b[1] - windDir), 360 - Math.abs(b[1] - windDir));
    return aDiff < bDiff ? a : b;
  })[0];
}

function checkLimits(windKts, gustKts, vis, desc, cloudCover, cloudBase) {
  if (windKts > 20) return { safe: false, msg: "Wind exceeds C42 limits (>20 kt)", field: "Wind" };
  if (gustKts > 20) return { safe: false, msg: "Gust exceeds C42 limits (>20 kt)", field: "Gusts" };
  if (vis < 5000) return { safe: false, msg: "Visibility too low (<5000 m)", field: "Visibility" };

  const descLower = desc.toLowerCase();
  if (descLower.includes("rain")) {
    if (cloudCover > 60 && descLower !== "light rain") {
      return { safe: false, msg: "Moderate or heavy rain with high cloud cover", field: "Weather" };
    }
    if (descLower === "light rain" && cloudCover > 30) {
      return { safe: true, warn: true, msg: "Light rain with moderate to high cloud cover - caution advised", field: "Weather" };
    }
  }
  if (descLower.includes("fog") || descLower.includes("mist")) {
    return { safe: false, msg: "Fog or mist present — not suitable", field: "Weather" };
  }
  if (cloudBase < 1000) return { safe: false, msg: "Estimated cloud base below 1000 ft AGL", field: "Cloud base" };

  return { safe: true, msg: "" };
}

function getTurbulenceRisk(windKts, gustKts) {
  if (gustKts > 20 || windKts > 20) return { risk: "High", className: "highlight-red" };
  if (gustKts > 15 || windKts > 15) return { risk: "Moderate", className: "highlight-yellow" };
  return { risk: "None", className: "highlight-green" };
}

function formatVisibility(vis) {
  return vis > 5000 ? ">5000 m" : `${vis} m`;
}

function averageForecasts(forecasts) {
  if (!forecasts.length) return null;
  const sum = {
    temp: 0,
    humidity: 0,
    pressure: 0,
    windSpeed: 0,
    windDeg: 0,
    gustSpeed: 0,
    visibility: 0,
    cloudCover: 0,
    dewPoint: 0,
  };
  let windX = 0, windY = 0;

  forecasts.forEach(f => {
    sum.temp += f.main.temp;
    sum.humidity += f.main.humidity;
    sum.pressure += f.main.pressure;
    sum.visibility += (f.visibility !== undefined ? f.visibility : 10000);
    sum.cloudCover += (f.clouds.all || 0);
    sum.gustSpeed += (f.wind.gust || 0);

    const angleRad = (f.wind.deg || 0) * Math.PI / 180;
    windX += Math.cos(angleRad);
    windY += Math.sin(angleRad);

    sum.windSpeed += f.wind.speed;
  });

  const count = forecasts.length;
  const avgTemp = sum.temp / count;
  const avgHumidity = sum.humidity / count;
  const avgPressure = sum.pressure / count;
  const avgVisibility = sum.visibility / count;
  const avgCloudCover = sum.cloudCover / count;
  const avgGustSpeed = sum.gustSpeed / count;
  const avgWindSpeed = sum.windSpeed / count;

  const avgWindDir = (Math.atan2(windY / count, windX / count) * 180 / Math.PI + 360) % 360;
  const avgDewPoint = estimateDewPoint(avgTemp, avgHumidity);
  const avgCloudBase = estimateCloudBase(avgTemp, avgDewPoint);

  return {
    avgTemp, avgHumidity, avgPressure, avgVisibility, avgCloudCover, avgGustSpeed, avgWindSpeed, avgWindDir, avgDewPoint, avgCloudBase
  };
}

async function checkFlight() {
  const resultsDiv = document.getElementById('results');
  const startInput = document.getElementById('start').value;
  const durationInput = parseFloat(document.getElementById('duration').value);

  if (!startInput || isNaN(durationInput) || durationInput <= 0) {
    resultsDiv.innerHTML = "<span class='highlight-red'>Please enter a valid start time and duration (hours > 0).</span>";
    return;
  }

  const startDate = new Date(startInput + 'Z');
  const endDate = new Date(startDate.getTime() + durationInput * 3600 * 1000);

  // API: fetch 3-hour forecast, find relevant forecast times overlapping flight window
  const apiUrl = `https://api.openweathermap.org/data/2.5/forecast?lat=${LAT}&lon=${LON}&appid=${API_KEY}&units=metric`;

  try {
    const response = await fetch(apiUrl);
    if (!response.ok) throw new Error("Weather API error");

    const data = await response.json();

    // Filter forecasts within flight window
    const flightForecasts = data.list.filter(f => {
      const forecastTime = new Date(f.dt * 1000);
      return forecastTime >= startDate && forecastTime <= endDate;
    });

    if (!flightForecasts.length) {
      resultsDiv.innerHTML = "<span class='highlight-red'>No forecast data available for flight time.</span>";
      return;
    }

    const avg = averageForecasts(flightForecasts);

    // Calculate conditions
    const temp = avg.avgTemp.toFixed(1);
    const humidity = avg.avgHumidity.toFixed(0);
    const pressure = avg.avgPressure.toFixed(0);
    const visibility = avg.avgVisibility;
    const visibilityStr = formatVisibility(visibility);
    const windSpeedKts = (avg.avgWindSpeed * 1.94384).toFixed(1);
    const gustSpeedKts = (avg.avgGustSpeed * 1.94384).toFixed(1);
    const windDir = avg.avgWindDir.toFixed(0);
    const cloudCover = avg.avgCloudCover.toFixed(0);
    const cloudBase = avg.avgCloudBase;
    const dewPoint = avg.avgDewPoint.toFixed(1);
    const icingRisk = getIcingRisk(avg.avgTemp, avg.avgDewPoint, avg.avgHumidity);
    const turbulence = getTurbulenceRisk(windSpeedKts, gustSpeedKts);
    const runway = predictRunway(avg.avgWindDir);

    // Wind shear check using surface wind and forecast upper wind (e.g. 850 hPa)
    // For simplicity, use current weather data for surface wind if available
    let windShearDetected = false;

    // Get current weather for surface wind
    const currentUrl = `https://api.openweathermap.org/data/2.5/weather?lat=${LAT}&lon=${LON}&appid=${API_KEY}&units=metric`;
    const currentResp = await fetch(currentUrl);
    if (currentResp.ok) {
      const currentData = await currentResp.json();
      const surfaceWind = currentData.wind;
      // Use 850 hPa wind from forecast (roughly 1500m)
      const upperWindData = data.list.find(f => f.main.pressure === 850) || flightForecasts[0];
      if (surfaceWind && upperWindData) {
        windShearDetected = predictWindShear(surfaceWind, upperWindData.wind, RUNWAYS[runway]);
      }
    }

    // Check limits & warnings
    const limitsCheck = checkLimits(parseFloat(windSpeedKts), parseFloat(gustSpeedKts), visibility, flightForecasts[0].weather[0].description, cloudCover, cloudBase);

    let output = "";
    output += `Flight time: ${formatDateUK(startDate)} to ${formatDateUK(endDate)}\n\n`;
    output += `Temperature: ${temp} °C\n`;
    output += `Humidity: ${humidity} %\n`;
    output += `Pressure: ${pressure} hPa\n`;
    output += `Visibility: ${visibilityStr}\n`;
    output += `Wind: ${windSpeedKts} kt @ ${windDir}°\n`;
    output += `Gusts: ${gustSpeedKts} kt\n`;
    output += `Cloud cover: ${cloudCover} %\n`;
    output += `Estimated cloud base: ${cloudBase} ft AGL\n`;
    output += `Dew point: ${dewPoint} °C\n\n`;

    output += `Icing risk: <span class="${icingRisk.className}">${icingRisk.risk}</span>\n`;
    output += `Turbulence risk: <span class="${turbulence.className}">${turbulence.risk}</span>\n`;
    output += `Suggested runway: ${runway}\n`;
    output += `Wind shear: ${windShearDetected ? '<span class="highlight-red">Possible wind shear detected</span>' : '<span class="ok">None detected</span>'}\n\n`;

    if (!limitsCheck.safe) {
      output += `<span class="highlight-red">WARNING: ${limitsCheck.msg}</span>\n`;
    } else if (limitsCheck.warn) {
      output += `<span class="highlight-yellow">Caution: ${limitsCheck.msg}</span>\n`;
    } else {
      output += `<span class="ok">Flight conditions within C42 limits.</span>\n`;
    }

    resultsDiv.innerHTML = output;

  } catch (error) {
    resultsDiv.innerHTML = `<span class="highlight-red">Error fetching weather data: ${error.message}</span>`;
  }
}
</script>
</body>
</html>
